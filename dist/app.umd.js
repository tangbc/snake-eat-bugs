!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){var t={27:"ESC",32:"SPACE",37:"LEFT",39:"RIGHT",38:"UP",40:"DOWN",65:"LEFT",68:"RIGHT",87:"UP",83:"DOWN"},e=navigator.userAgent,i=!!e.match(/Android/i),n=!!e.match(/iPhone|iPad|iPod/i),s=i||n,r=!!e.match(/MicroMessenger/i),o=function(t,e){return"UP"===e&&"DOWN"===t||"DOWN"===e&&"UP"===t||"LEFT"===e&&"RIGHT"===t||"RIGHT"===e&&"LEFT"===t},a=function(t){return(t>9?"":"0")+t},h=s?"RECORDS_MOBILE":"RECORDS",u=function(t){localStorage.setItem(h,JSON.stringify(t))},c=function(){return JSON.parse(localStorage.getItem(h))||[]},d=function(){return void 0!==document.createElement("div").style.animation?"animationend":"webkitAnimationEnd"},l=s?16:20,v=l/(s?2:1),f=screen.width,p=Math.floor(f/l)-1,m={UNIT:l,WIDTH:(s?p:33)*l,HEIGHT:(s?p:20)*l,BORDER:v,SCORE:1,LENGTH:1,SPEED:178,RECORDS:s?4:5},g=m.RECORDS,y=window.Sugar.Component.extend({init:function(t){this.Super("init",t,{class:"header",css:{width:m.WIDTH+"px","border-width":m.BORDER+"px"},template:"./template/header.html",model:{isMobile:s,score:0,broke:0,records:[],minute:"--",secound:"--"},cbRender:"initState"})},initState:function(){this.minute=0,this.secound=0,this.timer=null,this.over=!1,this.setRecordList()},setRecordList:function(){var t=c();t.length>g&&(t.length=g),this.vm.set("records",t)},startTime:function(){var t=this;this.timer=window.setTimeout(function(){t.secound++,60===t.secound&&(t.minute++,t.secound=0),t.vm.set({minute:a(t.minute),secound:a(t.secound)}),t.startTime()},1e3)},pauseTime:function(t){return this.timer||t?(window.clearTimeout(this.timer),this.timer=null):this.over||this.startTime(),this},end:function(){this.over=!0,this.updateRecords(),this.saveRecords(),this.pauseTime(!0)},addScore:function(){var t=this.vm.$data;if(t.score=t.score+m.SCORE,1!==t.broke){var e=this.findRecordIndex(),i=e.index;i>-1&&i<3&&!e.isEqual&&(t.broke=i+1)}},findRecordIndex:function(){for(var t=this.vm.$data,e=t.score,i=t.records,n=-1,s=!1,r=0;r<i.length;r++){var o=i[r];if(e>=o.score){n=r,s=e===o.score;break}}return{index:n,isEqual:s}},updateRecords:function(){var t=this.vm.$data,e=t.score,i=t.records,n=i.length;if(!(n>=g&&e<i[n-1].score)){var s={score:e,times:1},r=this.findRecordIndex(e),o=r.index;o>-1&&(r.isEqual?i[o].times++:i.splice(o,0,s)),i.length>g&&i.splice(g,i.length-g)}},saveRecords:function(){var t=this.vm.$data,e=t.score,i=t.records;if(e)if(i.length)u(i);else{var n=[{score:e,times:1}];u(n),this.vm.$data.records=n}},reset:function(){this.pauseTime(!0),this.vm.reset(),this.initState()}}),b=function(t,e){var i=Object.values(t),n=i[1];return e.indexOf(i[0])>-1&&e.indexOf(n)>-1},x=function(t,e){this.x=0,this.y=0,this.rows=t,this.lines=e,this.leftovers=[],this.availables=[],this.initAvailables()};x.prototype.initAvailables=function(){for(var t=this.rows-(s?4:2),e=this.lines-(s?3:2),i=[],n=1;n<=t;n++)for(var r=1;r<=e;r++)i.push(n+","+r);this.availables=function(t){for(var e=-1,i=t.length,n=i-1,s=t.slice(0);++e<i;){var r=e+Math.floor(Math.random()*(n-e+1)),o=s[r];s[r]=s[e],s[e]=o}return s}(i)},x.prototype.create=function(t){var e=this.getNext(t);return e?(this.x=e.x,this.y=e.y,this.remove(e.x,e.y),{x:e.x,y:e.y,eaten:!1}):null},x.prototype.getNext=function(t){for(var e="",i=!1,n=0;n<this.availables.length;n++)if(-1===t.indexOf(e=this.availables[n])){i=!0;break}if(i&&e){var s=e.split(","),r=s[0],o=s[1];return this.isTrapped(r=+r,o=+o)?(this.remove(r,o),this.getNext(t)):{x:r,y:o}}return null},x.prototype.isTrapped=function(t,e){var i={B1:t-1+","+(e-1),B3:t-1+","+(e+1)},n={C1:t+","+(e-2),C2:t+1+","+(e-1)},s={D2:t-1+","+(e+1),D3:t+","+(e+2)},r={E1:t+1+","+(e-1),E3:t+1+","+(e+1)},o={F1:t+","+(e-2),F2:t-1+","+(e-1)},a={G2:t+1+","+(e-1),G3:t+2+","+e},h={H1:t-1+","+(e+1),H3:t+1+","+(e+1)},u={I1:t-2+","+e,I2:t-1+","+(e-1)},c={J2:t+1+","+(e+1),J3:t+2+","+e},d={K1:t-1+","+(e-1),K3:t+1+","+(e-1)},l={L1:t-2+","+e,L2:t-1+","+(e+1)};return!!(b({A2:t+1+","+(e+1),A3:t+","+(e+2)},this.leftovers)||b(i,this.leftovers)||b(n,this.leftovers)||b(s,this.leftovers)||b(r,this.leftovers)||b(o,this.leftovers)||b(a,this.leftovers)||b(h,this.leftovers)||b(u,this.leftovers)||b(c,this.leftovers)||b(d,this.leftovers)||b(l,this.leftovers))},x.prototype.remove=function(t,e){var i=this.availables.indexOf(t+","+e);-1!==i&&this.availables.splice(i,1)},x.prototype.check=function(t,e){return this.x===t&&this.y===e?0:this.leftovers.indexOf(t+","+e)>-1?1:void 0},x.prototype.addEaten=function(t,e){this.leftovers.push(t+","+e)},x.prototype.reset=function(){this.x=0,this.y=0,this.leftovers=[],this.initAvailables()};var E=function(){this.audios=Object.create(null),this.audios.eats=document.querySelector("#eats"),this.audios.turn=document.querySelector("#turn"),this.audios.dead=document.querySelector("#dead"),r&&n&&(this.wxjsb=null,this.initWxBrowserEvent())};E.prototype.initWxBrowserEvent=function(){var t=this;document.addEventListener("WeixinJSBridgeReady",function(){t.wxjsb=window.WeixinJSBridge})},E.prototype.play=function(t){var e=this.audios[t];if(e)if(this.wxjsb&&"dead"!==t)try{this.wxjsb.invoke("getNetworkType",{},function(){e.play()})}catch(t){e.play()}else e.play()};var w=new E,T=m.UNIT,O=m.WIDTH,S=m.HEIGHT,R=m.LENGTH,L="head",D="body",B="dead",k=Math.floor(O/T),C=Math.floor(S/T),M=Math.floor(C/2)-1,P=Math.floor((k-R)/2),I=k-1,H=C-1,N=function(t,e){return["top: "+t+"px; left: "+e+"px;",t?"border-top: 1px dashed #ccc;":"bottom: 0px;",e?"border-left: 1px dashed #ccc;":"right: 0px;","padding: 0; margin: 0; position: absolute; overflow: hidden;"].join("")},$=function(t,e,i){return{x:t,y:e,type:i,life:"",direct:""}},G=window.Sugar,W=G.Component.extend({init:function(t){for(var e=[$(P,M,L)],i=1;i<R+1;i++)e.push($(P+i,M,D));this.Super("init",t,{class:"playground",css:{width:O+"px",height:S+"px","border-width":m.BORDER+"px"},template:"./template/playground.html",model:{isMobile:s,isPause:!1,gridLines:"",running:!1,showResult:!1,unit:T,scale:T+"px",bgsize:T+"px "+T+"px",snakes:e,bugs:[]},methods:{cancelPause:function(){this.pause()}}})},afterRender:function(){this.initState(),this.buildGrid(),this.bug=new x(k,C),this.addBug(),s&&this.initMobileEvent()},initMobileEvent:function(){var t=this;this.el.addEventListener("touchstart",function(t,e){var i=["touchend"],n=["touchmove","touchcancel","touchstart"];function s(e){if(e.touches&&!(e.touches.length>1)){var s=this,o=arguments,a=setTimeout(u,r);n.forEach(function(t){document.addEventListener(t,u)}),i.forEach(function(t){document.addEventListener(t,h)})}function h(i){if(e!==i&&(u(),!i.defaultPrevented)){var n=e.preventDefault,r=e.stopPropagation;i.stopPropagation=function(){r.call(e),r.call(i)},i.preventDefault=function(){n.call(e),n.call(i)},o[0]=i,t.apply(s,o)}}function u(t){e!==t&&(clearTimeout(a),n.forEach(function(t){document.removeEventListener(t,u)}),i.forEach(function(t){document.removeEventListener(t,h)}))}}var r=(e=e||{}).timeout||200;return s.handler=t,s}(function(){t.fire("onMobilePlaygroundTouch")})),this.query("#over").addEventListener(d(),function(){t.fire("onGameOver")})},initState:function(){this.rest=!1,this.timer=null,this.x=P,this.y=M,this.over=!1,this.direct="LEFT"},buildGrid:function(){var t,e="";for(t=0;t<=I;t++)e+='<p style="'+N(0,T*t)+'"></p>';for(t=0;t<=H;t++)e+='<p style="'+N(T*t,0)+'"></p>';this.vm.$els.grid.innerHTML=e},start:function(){var t=this;this.vm.$data.running=!0,this.timer=window.setTimeout(function(){switch(t.direct){case"UP":t.turnUp();break;case"DOWN":t.turnDown();break;case"LEFT":t.turnLeft();break;case"RIGHT":t.turnRight();break;default:return}t.over||t.moveBody().moveHead().check().start()},m.SPEED)},turnUp:function(){this.y>0?this.y--:this.gameOver()},turnDown:function(){this.y<H?this.y++:this.gameOver()},turnLeft:function(){this.x>0?this.x--:this.gameOver()},turnRight:function(){this.x<I?this.x++:this.gameOver()},moveHead:function(){var t=this.vm.$data.snakes;return t[0].x=this.x,t[0].y=this.y,t[0].direct=this.direct,this},moveBody:function(){for(var t=this.vm.$data.snakes,e=t.length-1;e>0;e--)t[e].x=t[e-1].x,t[e].y=t[e-1].y;return this},check:function(){return this.checkEatSelf(),this.checkEatLeftover(),this},checkEatSelf:function(){for(var t=this.vm.$data.snakes,e=1;e<t.length;e++)this.x===t[e].x&&this.y===t[e].y&&this.gameOver()},checkEatLeftover:function(){var t=this.bug.check(this.x,this.y);0===t?this.eatBug().addBug():1===t&&this.gameOver()},eatBug:function(){return this.addGrub(),this.rest=!1,this.vm.$data.bugs[0].eaten=!0,this.bug.addEaten(this.x,this.y),this.fire("onEatBug"),w.play("eats"),this},addGrub:function(){var t=this.vm.$data.snakes,e=t.length-1;t.push($(t[e].x,t[e].y,D))},addBug:function(t){if(!this.rest||t){var e=this.vm.$data,i=this.getSnakeZone(e.snakes),n=this.bug.create(i);n?(this.rest=!0,e.bugs.unshift(n)):this.noAvailablePlace||(this.noAvailablePlace=!0,alert("👍👍👍 No available bug already!"))}},getSnakeZone:function(t){var e=[];return G.util.each(t,function(t){e.push(t.x+","+t.y)}),e},gameOver:function(){var t=this.vm.$data;this.pause(!0),this.over=!0;var e=0;G.util.each(t.snakes,function(t,i){e=50*i,setTimeout(function(){t.life=B},e)}),w.play("dead"),setTimeout(function(){t.showResult=!0},e+250),s||this.fire("onGameOver")},pause:function(t){var e=this.vm.$data;this.timer||t?(window.clearTimeout(this.timer),this.timer=null,t||(e.isPause=!0)):this.over||(this.start(),e.isPause=!1)},update:function(t){o(this.direct,t)||this.vm.$data.isPause||(this.direct!==t&&w.play("turn"),this.direct=t)},reset:function(){this.pause(!0),this.initState(),this.vm.reset(),this.bug.reset(),this.addBug()}}),U=window.Sugar.Component.extend({init:function(t){this.Super("init",t,{class:"wheel",css:{width:m.WIDTH+"px"},template:"./template/wheel.html",model:{init:!0,direct:""}})},switchDirect:function(t){var e=this.vm.$data;this.isBegin&&!o(e.direct,t)&&e.direct!==t&&(e.direct=t,this.fire("onUpdateDirectFromWheel",t))},afterRender:function(){var t=this;this.moveX=0,this.moveY=0,this.isOver=!1,this.isBegin=!1,setTimeout(function(){t.updatePosition()},100),this.el.addEventListener("touchstart",this.eventTouchstart.bind(this)),this.el.addEventListener("touchmove",this.eventTouchmove.bind(this)),this.el.addEventListener("touchend",this.eventTouchend.bind(this)),this.el.addEventListener("touchcancel",this.eventTouchcancel.bind(this))},updatePosition:function(){var t=this.el.parentNode.getBoundingClientRect();this.el.style.top=t.bottom+10+"px"},eventTouchstart:function(t){if(this.isBegin&&!this.isOver){var e=t.touches[0],i=e.clientY;this.moveX=e.clientX,this.moveY=i,this.el.classList.add("press")}},eventTouchmove:function(t){if(t.preventDefault(),this.isBegin&&!this.isOver){var e=t.touches[0],i=e.clientY,n=Math.round(e.clientX),s=Math.round(i),r=n-this.moveX,o=s-this.moveY;Math.abs(r)>Math.abs(o)&&r>0?this.switchDirect("RIGHT"):Math.abs(r)>Math.abs(o)&&r<0?this.switchDirect("LEFT"):Math.abs(r)<Math.abs(o)&&o>0?this.switchDirect("DOWN"):Math.abs(r)<Math.abs(o)&&o<0&&this.switchDirect("UP")}},eventTouchend:function(t){this.end()},eventTouchcancel:function(t){this.end()},end:function(){this.moveX=0,this.moveY=0,this.el.classList.remove("press")},start:function(){this.isBegin=!0;var t=this.vm.$data;t.init=!1,t.direct="LEFT"},over:function(){this.isOver=!0},pause:function(){this.isBegin=!this.isBegin},reset:function(){this.moveX=0,this.moveY=0,this.isOver=!1,this.isBegin=!1,this.vm.$data.direct=""}}),A=window.Sugar.Component.extend({init:function(t){this.Super("init",t,{target:"#app",css:{width:m.WIDTH+m.UNIT+"px"},model:{isMobile:s,loading:!0},childs:{"app-header":y,"app-playground":W}})},afterRender:function(){this.isOver=!1,this.isBegin=!1,this.vm.$data.loading=!1,this.on(document,"keydown",this.documentKeyDown),s&&this.create("app-wheel",U,{target:this.query(".ready")})},documentKeyDown:function(e){var i=t[e.keyCode],n=this.getChild("app-playground");"SPACE"===i?this.interrupt():"ESC"===i?this.reset():this.isBegin&&i&&n.update(i)},onGameOver:function(){this.isOver=!0,this.getChild("app-header").end(),s&&this.getChild("app-wheel").over()},onEatBug:function(){this.getChild("app-header").addScore()},onMobilePlaygroundTouch:function(){this.isOver?this.reset():this.interrupt()},onUpdateDirectFromWheel:function(t){var e=t&&t.param;this.isBegin&&!this.isOver&&e&&this.getChild("app-playground").update(e)},interrupt:function(){var t=this.getChild("app-header"),e=this.getChild("app-playground"),i=this.getChild("app-wheel");this.isBegin?(t.pauseTime(),e.pause(),s&&i&&i.pause()):(this.isBegin=!0,t.startTime(),e.start(),s&&i&&i.start())},reset:function(){this.isOver=!1,this.isBegin=!1,this.getChild("app-header").reset(),this.getChild("app-playground").reset(),s&&this.getChild("app-wheel").reset()}}),F=function(){window.app=window.Sugar.core.create("app",A)},q=document.querySelector("#game-name");q.classList.add("bounceInDown"),q.style.visibility="visible",s?(q.addEventListener(d(),function(){setTimeout(function(){q.parentNode.removeChild(q),F()},500)}),window.addEventListener("orientationchange",function(){screen.orientation&&screen.orientation.angle&&alert("Not support horizontal screen!")})):window.addEventListener("load",F)});
